// ============================================
// ConectCampo - Prisma Schema
// Marketplace SaaS de crédito agro
// ============================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────
// ENUMS
// ──────────────────────────────────────────────

enum UserRole {
  PRODUCER
  COMPANY
  FINANCIAL_INSTITUTION
  CREDIT_ANALYST
  ADMIN
}

enum ProducerTier {
  FAIXA_A // Até R$ 500k
  FAIXA_B // R$ 500k–R$ 5M
  FAIXA_C // R$ 5M–R$ 50M
  FAIXA_D // R$ 50M+
}

enum OperationType {
  CUSTEIO
  INVESTIMENTO
  GIRO
  MERCADO_CAPITAIS
}

enum OperationStatus {
  DRAFT
  SUBMITTED
  SCORING
  MATCHING
  PROPOSALS_RECEIVED
  ACCEPTED
  IN_ANALYSIS
  APPROVED
  REJECTED
  CONTRACTED
  COMPLETED
  CANCELLED
}

enum DocumentType {
  CPF
  CNPJ
  CAR
  ITR
  CCIR
  ESCRITURA
  BALANCO
  DRE
  IR
  NOTA_FISCAL
  CPR
  CONTRATO_SOCIAL
  PROCURACAO
  LAUDO_AVALIACAO
  CERTIDAO_NEGATIVA
  OUTRO
}

enum GuaranteeType {
  IMOVEL_RURAL
  PENHOR_SAFRA
  ALIENACAO_FIDUCIARIA
  AVAL
  RECEBIVEIS
  CPR_FINANCEIRA
  SEGURO
  FUNDO_GARANTIDOR
  OUTRO
}

enum PartnerType {
  BANCO
  COOPERATIVA
  FIDC
  SECURITIZADORA
  FIAGRO
  MERCADO_CAPITAIS
  ESTRUTURADOR
}

enum SubscriptionPlan {
  START
  PRO
  CORPORATE
}

enum RiskProfile {
  CONSERVADOR
  MODERADO
  ESTRUTURADO
}

enum ProposalStatus {
  PENDING
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
  NEGOTIATING
}

enum CommissionStatus {
  PENDING
  CALCULATED
  INVOICED
  PAID
}

enum CropType {
  SOJA
  MILHO
  CAFE
  ALGODAO
  CANA
  ARROZ
  TRIGO
  FEIJAO
  PECUARIA_CORTE
  PECUARIA_LEITE
  AVICULTURA
  SUINOCULTURA
  FRUTICULTURA
  SILVICULTURA
  OUTRO
}

enum BrazilianState {
  AC
  AL
  AP
  AM
  BA
  CE
  DF
  ES
  GO
  MA
  MT
  MS
  MG
  PA
  PB
  PR
  PE
  PI
  RJ
  RN
  RS
  RO
  RR
  SC
  SP
  SE
  TO
}

// ──────────────────────────────────────────────
// USER & AUTH
// ──────────────────────────────────────────────

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  passwordHash   String
  name           String
  role           UserRole
  phone          String?
  cpf            String?   @unique
  avatarUrl      String?
  emailVerified  Boolean   @default(false)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  consentLgpd    Boolean   @default(false)
  consentLgpdAt  DateTime?

  // Multi-tenant
  tenantId       String?

  // Soft delete
  deletedAt      DateTime?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  company          Company?          @relation("CompanyOwner")
  companyMembers   CompanyMember[]
  producerProfile  ProducerProfile?
  documents        Document[]
  subscriptions    Subscription[]
  auditLogs        AuditLog[]
  refreshTokens    RefreshToken[]
  notifications    Notification[]

  @@index([email])
  @@index([role])
  @@index([tenantId])
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────
// COMPANY & MULTI-TENANT
// ──────────────────────────────────────────────

model Company {
  id                 String         @id @default(uuid())
  cnpj               String         @unique
  razaoSocial        String
  nomeFantasia       String?
  inscricaoEstadual  String?
  state              BrazilianState
  city               String
  address            String?
  ownerId            String         @unique

  isActive           Boolean        @default(true)
  deletedAt          DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  owner              User           @relation("CompanyOwner", fields: [ownerId], references: [id])
  members            CompanyMember[]
  producerProfiles   ProducerProfile[]
  employees          Employee[]

  @@index([cnpj])
  @@map("companies")
}

model CompanyMember {
  id        String   @id @default(uuid())
  userId    String
  companyId String
  role      String   @default("member") // owner, admin, member
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

// ──────────────────────────────────────────────
// PRODUCER PROFILE
// ──────────────────────────────────────────────

model ProducerProfile {
  id                String         @id @default(uuid())
  userId            String         @unique
  companyId         String?
  tier              ProducerTier
  annualRevenue     Decimal        @db.Decimal(15, 2)
  totalArea         Decimal        @db.Decimal(12, 2) // hectares
  crops             CropType[]
  state             BrazilianState
  city              String
  hasIrrigation     Boolean        @default(false)
  hasInsurance      Boolean        @default(false)
  yearsInActivity   Int            @default(0)
  numberOfEmployees Int?

  deletedAt         DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  company           Company?          @relation(fields: [companyId], references: [id])
  financialProfile  FinancialProfile?
  operations        OperationRequest[]
  riskScores        RiskScore[]

  @@index([tier])
  @@index([state])
  @@map("producer_profiles")
}

// ──────────────────────────────────────────────
// FINANCIAL PROFILE
// ──────────────────────────────────────────────

model FinancialProfile {
  id                   String          @id @default(uuid())
  producerProfileId    String          @unique
  annualRevenue        Decimal         @db.Decimal(15, 2)
  totalDebt            Decimal         @db.Decimal(15, 2) @default(0)
  debtToRevenueRatio   Decimal         @db.Decimal(5, 4) @default(0)
  cashFlowMonthly      Decimal[]       @db.Decimal(15, 2) // 12 months
  guaranteeValue       Decimal         @db.Decimal(15, 2) @default(0)
  hasNegativeRecords   Boolean         @default(false)
  creditHistoryYears   Int             @default(0)

  deletedAt            DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  producerProfile      ProducerProfile @relation(fields: [producerProfileId], references: [id], onDelete: Cascade)

  @@map("financial_profiles")
}

// ──────────────────────────────────────────────
// OPERATION REQUEST
// ──────────────────────────────────────────────

model OperationRequest {
  id                 String           @id @default(uuid())
  producerProfileId  String
  type               OperationType
  status             OperationStatus  @default(DRAFT)
  requestedAmount    Decimal          @db.Decimal(15, 2)
  termMonths         Int
  purpose            String
  guarantees         GuaranteeType[]
  guaranteeValue     Decimal          @db.Decimal(15, 2) @default(0)
  notes              String?

  deletedAt          DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  producerProfile    ProducerProfile  @relation(fields: [producerProfileId], references: [id])
  documents          Document[]
  riskScore          RiskScore?
  matchResults       MatchResult[]
  proposals          Proposal[]
  contract           Contract?
  commissions        Commission[]

  @@index([status])
  @@index([type])
  @@index([producerProfileId])
  @@map("operation_requests")
}

// ──────────────────────────────────────────────
// DOCUMENT / DATA ROOM
// ──────────────────────────────────────────────

model Document {
  id            String       @id @default(uuid())
  operationId   String?
  userId        String
  type          DocumentType
  fileName      String
  fileKey       String       // S3 key
  fileUrl       String
  fileSize      Int          // bytes
  mimeType      String
  version       Int          @default(1)
  isVerified    Boolean      @default(false)
  verifiedBy    String?
  verifiedAt    DateTime?
  expiresAt     DateTime?
  checksum      String?      // SHA-256

  deletedAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  operation     OperationRequest? @relation(fields: [operationId], references: [id])
  user          User              @relation(fields: [userId], references: [id])
  accessGrants  DocumentAccess[]

  @@index([operationId])
  @@index([userId])
  @@index([type])
  @@map("documents")
}

model DocumentAccess {
  id            String   @id @default(uuid())
  documentId    String
  partnerId     String
  grantedAt     DateTime @default(now())
  expiresAt     DateTime?
  accessedAt    DateTime?

  document      Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  partner       PartnerInstitution @relation(fields: [partnerId], references: [id])

  @@unique([documentId, partnerId])
  @@map("document_access")
}

// ──────────────────────────────────────────────
// RISK SCORE
// ──────────────────────────────────────────────

model RiskScore {
  id                 String          @id @default(uuid())
  producerProfileId  String
  operationId        String?         @unique
  score              Int             // 0–100
  profile            RiskProfile
  factors            Json            // { name, weight, value, maxValue }[]
  eligibility        Json            // { partnerType, eligible, reason, maxAmount }[]
  validUntil         DateTime

  createdAt          DateTime        @default(now())

  // Relations
  producerProfile    ProducerProfile  @relation(fields: [producerProfileId], references: [id])
  operation          OperationRequest? @relation(fields: [operationId], references: [id])

  @@index([producerProfileId])
  @@index([score])
  @@map("risk_scores")
}

// ──────────────────────────────────────────────
// PARTNER INSTITUTION
// ──────────────────────────────────────────────

model PartnerInstitution {
  id                  String           @id @default(uuid())
  name                String
  type                PartnerType
  cnpj                String           @unique
  contactEmail        String
  contactPhone        String?
  logoUrl             String?

  // Tese / Criteria
  minTicket           Decimal          @db.Decimal(15, 2) @default(0)
  maxTicket           Decimal          @db.Decimal(15, 2) @default(0)
  acceptedGuarantees  GuaranteeType[]
  acceptedCrops       CropType[]
  acceptedStates      BrazilianState[]
  acceptedOperations  OperationType[]
  minScore            Int              @default(0)
  maxDebtRatio        Decimal          @db.Decimal(5, 4) @default(0)
  customCommissionRate Decimal?        @db.Decimal(5, 4)

  isActive            Boolean          @default(true)
  deletedAt           DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  matchResults        MatchResult[]
  proposals           Proposal[]
  commissions         Commission[]
  documentAccess      DocumentAccess[]

  @@index([type])
  @@index([isActive])
  @@map("partner_institutions")
}

// ──────────────────────────────────────────────
// MATCH RESULT
// ──────────────────────────────────────────────

model MatchResult {
  id            String   @id @default(uuid())
  operationId   String
  partnerId     String
  matchScore    Int      // 0–100
  matchFactors  Json     // { name, weight, score, description }[]
  rank          Int

  createdAt     DateTime @default(now())

  // Relations
  operation     OperationRequest   @relation(fields: [operationId], references: [id])
  partner       PartnerInstitution @relation(fields: [partnerId], references: [id])

  @@unique([operationId, partnerId])
  @@index([operationId])
  @@index([matchScore])
  @@map("match_results")
}

// ──────────────────────────────────────────────
// PROPOSAL
// ──────────────────────────────────────────────

model Proposal {
  id                 String         @id @default(uuid())
  operationId        String
  partnerId          String
  amount             Decimal        @db.Decimal(15, 2)
  interestRate       Decimal        @db.Decimal(5, 4) // % a.a.
  termMonths         Int
  conditions         String?
  requiredGuarantees GuaranteeType[]
  status             ProposalStatus @default(PENDING)
  validUntil         DateTime
  respondedAt        DateTime?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  operation          OperationRequest   @relation(fields: [operationId], references: [id])
  partner            PartnerInstitution @relation(fields: [partnerId], references: [id])

  @@index([operationId])
  @@index([partnerId])
  @@index([status])
  @@map("proposals")
}

// ──────────────────────────────────────────────
// CONTRACT
// ──────────────────────────────────────────────

model Contract {
  id              String   @id @default(uuid())
  operationId     String   @unique
  contractNumber  String   @unique
  signedAmount    Decimal  @db.Decimal(15, 2)
  interestRate    Decimal  @db.Decimal(5, 4)
  termMonths      Int
  startDate       DateTime
  endDate         DateTime
  signedAt        DateTime?
  signatureHash   String?  // hash assinatura eletrônica
  contractFileUrl String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  operation       OperationRequest @relation(fields: [operationId], references: [id])

  @@map("contracts")
}

// ──────────────────────────────────────────────
// SUBSCRIPTION & MONETIZATION
// ──────────────────────────────────────────────

model Subscription {
  id                    String           @id @default(uuid())
  userId                String
  plan                  SubscriptionPlan @default(START)
  stripeSubscriptionId  String?          @unique
  stripeCustomerId      String?
  isActive              Boolean          @default(true)
  currentPeriodStart    DateTime         @default(now())
  currentPeriodEnd      DateTime
  cancelledAt           DateTime?

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  // Relations
  user                  User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([plan])
  @@map("subscriptions")
}

model Commission {
  id               String           @id @default(uuid())
  operationId      String
  partnerId        String
  contractedAmount Decimal          @db.Decimal(15, 2)
  commissionRate   Decimal          @db.Decimal(5, 4)
  commissionValue  Decimal          @db.Decimal(15, 2)
  fixedFee         Decimal          @db.Decimal(15, 2) @default(0)
  status           CommissionStatus @default(PENDING)
  paidAt           DateTime?
  invoiceUrl       String?

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  operation        OperationRequest   @relation(fields: [operationId], references: [id])
  partner          PartnerInstitution @relation(fields: [partnerId], references: [id])

  @@index([operationId])
  @@index([status])
  @@map("commissions")
}

// ──────────────────────────────────────────────
// BENEFITS MARKETPLACE
// ──────────────────────────────────────────────

model BenefitPlan {
  id           String   @id @default(uuid())
  name         String
  category     String   // telemedicina, seguro, odonto etc.
  provider     String
  description  String?
  monthlyPrice Decimal  @db.Decimal(10, 2)
  features     Json     // lista de features
  isActive     Boolean  @default(true)

  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  enrollments  BenefitEnrollment[]

  @@map("benefit_plans")
}

model Employee {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  cpf         String
  email       String?
  phone       String?
  role        String?  // cargo
  isActive    Boolean  @default(true)

  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     Company  @relation(fields: [companyId], references: [id])
  benefits    BenefitEnrollment[]

  @@index([companyId])
  @@map("employees")
}

model BenefitEnrollment {
  id           String      @id @default(uuid())
  employeeId   String
  benefitPlanId String
  startDate    DateTime    @default(now())
  endDate      DateTime?
  isActive     Boolean     @default(true)
  coparticipation Decimal? @db.Decimal(5, 4) // %

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  employee     Employee    @relation(fields: [employeeId], references: [id])
  benefitPlan  BenefitPlan @relation(fields: [benefitPlanId], references: [id])

  @@unique([employeeId, benefitPlanId])
  @@map("benefit_enrollments")
}

// ──────────────────────────────────────────────
// AUDIT & COMPLIANCE
// ──────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity     String   // nome da entidade
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?

  createdAt  DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id])

  // Logs imutáveis — sem updatedAt

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ──────────────────────────────────────────────
// NOTIFICATIONS
// ──────────────────────────────────────────────

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   // info, warning, success, error
  isRead    Boolean  @default(false)
  link      String?
  metadata  Json?

  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}
